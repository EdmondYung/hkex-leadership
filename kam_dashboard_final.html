<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Key Audit Matters (KAM) Analysis - Actual Data</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 20px;
            border: 1px solid #c3e6cb;
        }

        .stats-bar {
            background: #f8f9fa;
            padding: 20px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            border-bottom: 1px solid #e9ecef;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .filter-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-item label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9em;
        }

        .filter-item select, .filter-item input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .content {
            padding: 30px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }

        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-canvas {
            max-height: 400px;
        }

        .data-section {
            width: 100%;
            margin-top: 30px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .section-header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .cards-container {
            max-height: 800px;
            overflow-y: auto;
            padding: 20px;
        }

        .kam-card {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            position: relative;
        }

        .kam-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .card-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
            flex: 1;
            min-width: 200px;
        }

        .card-meta {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .company-tag {
            background: #007bff;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .year-tag {
            background: #28a745;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .auditor-tag {
            background: #6f42c1;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .card-description {
            color: #495057;
            line-height: 1.5;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #f1f3f4;
        }

        .audit-response {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-top: 15px;
            border-radius: 0 5px 5px 0;
        }

        .audit-response-header {
            font-weight: 600;
            color: #007bff;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .audit-response-content {
            color: #495057;
            line-height: 1.5;
        }

        .description-preview {
            display: block;
        }

        .description-full {
            display: none;
        }

        .show-more-btn {
            color: #007bff;
            cursor: pointer;
            font-size: 0.9em;
            text-decoration: underline;
            margin-top: 5px;
            display: inline-block;
        }

        .show-more-btn:hover {
            color: #0056b3;
        }

        .pagination-info {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-style: italic;
            background: #f8f9fa;
            margin-top: 15px;
            border-radius: 5px;
        }

        /* Enhanced Search Styles */
        .enhanced-search {
            position: relative;
            margin-bottom: 10px;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f1f3f4;
        }

        .suggestion-item:hover {
            background: #f8f9fa;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .search-highlight {
            background: #fff3cd;
            padding: 1px 3px;
            border-radius: 3px;
        }

        /* Risk Category Styles */
        .risk-category {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 500;
            margin-left: 8px;
        }

        .risk-revenue { background: #e3f2fd; color: #1976d2; }
        .risk-valuation { background: #f3e5f5; color: #7b1fa2; }
        .risk-compliance { background: #e8f5e8; color: #388e3c; }
        .risk-operational { background: #fff3e0; color: #f57c00; }
        .risk-financial { background: #ffebee; color: #d32f2f; }
        .risk-other { background: #f5f5f5; color: #616161; }

        /* Comparison Tool Styles */
        .comparison-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
        }

        .compare-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin: 2px;
        }

        .compare-btn:hover {
            background: #218838;
        }

        .card-checkbox {
            position: absolute;
            top: 15px;
            right: 15px;
            transform: scale(1.2);
        }

        .comparison-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
        }

        .comparison-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            width: 90%;
            max-width: 1200px;
            height: 80%;
            border-radius: 10px;
            overflow: hidden;
        }

        .comparison-header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comparison-body {
            display: flex;
            height: calc(100% - 80px);
            overflow: hidden;
        }

        .comparison-card {
            flex: 1;
            padding: 20px;
            border-right: 1px solid #e9ecef;
            overflow-y: auto;
        }

        .comparison-card:last-child {
            border-right: none;
        }

        .kam-description:hover {
            white-space: normal;
            overflow: visible;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        /* Auditor Table Styles */
        .auditor-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .auditor-table th,
        .auditor-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .auditor-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            font-size: 0.9em;
        }

        .auditor-table tr:hover {
            background: #f8f9fa;
        }

        .auditor-table tr:last-child td {
            border-bottom: none;
        }

        .exchange-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .auditor-name {
            color: #6f42c1;
            font-weight: 500;
        }

        .kam-count {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
            text-align: center;
        }

        /* Risk Matrix Styles */
        .risk-matrix-legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85em;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }

            .stats-bar {
                flex-direction: column;
            }

            .auditor-table {
                font-size: 0.9em;
            }

            .auditor-table th,
            .auditor-table td {
                padding: 8px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔍 Key Audit Matters Analysis</h1>
            <p>Interactive Dashboard - Actual Tidied Data (2015-2024)</p>
        </div>

        <div class="success-message" id="dataSourceMessage">
            ✅ <strong>Complete KAM Dataset Loaded!</strong> Displaying all 131 verified KAM records with auditor responses as interactive cards.
            Each card includes both the Key Audit Matter and the corresponding Auditor's Response from your tidied dataset.
        </div>

        <div class="data-source-info" id="dataSourceInfo" style="
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-size: 0.9em;
            color: #1976d2;
            display: none;
        ">
            <strong>📁 Data Source:</strong> <code>actual_kam_data.js</code> |
            <strong>📊 Records:</strong> <span id="recordCount">-</span> |
            <strong>🏢 Companies:</strong> <span id="companyCount">-</span> |
            <strong>👥 Auditors:</strong> <span id="auditorCount">-</span> |
            <strong>📅 Years:</strong> <span id="yearRange">-</span> |
            <strong>🕒 Loaded:</strong> <span id="loadTime">-</span>
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-number" id="totalKAMs">131</div>
                <div class="stat-label">Total KAMs</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalCompanies">7</div>
                <div class="stat-label">Companies</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalAuditors">4</div>
                <div class="stat-label">Auditors</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="yearRange">2015-2024</div>
                <div class="stat-label">Year Range</div>
            </div>
        </div>

        <div class="controls">
            <div class="filter-group">
                <div class="filter-item">
                    <label for="companyFilter">Filter by Company:</label>
                    <select id="companyFilter">
                        <option value="">All Companies</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="auditorFilter">Filter by Auditor:</label>
                    <select id="auditorFilter">
                        <option value="">All Auditors</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="yearFilter">Filter by Year:</label>
                    <select id="yearFilter">
                        <option value="">All Years</option>
                    </select>
                </div>
                <div class="filter-item" style="background: #e3f2fd; border: 2px solid #2196f3; padding: 10px; border-radius: 5px;">
                    <label for="yearSelector">📅 Select Year for Statistics:</label>
                    <select id="yearSelector" onchange="updateYearBasedData()">
                        <option value="">All Years</option>
                    </select>
                </div>
                <div class="filter-item" style="background: #f3e5f5; border: 2px solid #9c27b0; padding: 10px; border-radius: 5px;">
                    <label for="riskCategoryFilter">🎯 Filter by Risk Category:</label>
                    <select id="riskCategoryFilter">
                        <option value="">All Risk Categories</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="searchFilter">🔍 Enhanced Search:</label>
                    <div class="enhanced-search">
                        <input type="text" id="searchFilter" class="search-input"
                               placeholder="Search KAMs, auditor responses, companies..."
                               onkeyup="handleSearch()"
                               onfocus="showSearchSuggestions()"
                               onblur="hideSearchSuggestions()">
                        <span class="search-icon">🔍</span>
                        <div id="searchSuggestions" class="search-suggestions"></div>
                    </div>
                </div>
                <div class="filter-item">
                    <label>📄 Export Options:</label>
                    <div style="display: flex; gap: 10px; margin-top: 5px;">
                        <button onclick="exportToPDF()" class="compare-btn" style="background: #dc3545;">Export PDF</button>
                        <button onclick="exportToExcel()" class="compare-btn" style="background: #28a745;">Export Excel</button>
                    </div>
                </div>
                <div class="filter-item">
                    <label>🔄 Data Management:</label>
                    <div style="display: flex; gap: 10px; margin-top: 5px;">
                        <button onclick="refreshData()" class="compare-btn" style="background: #17a2b8;">Refresh Data</button>
                        <button onclick="showDataInfo()" class="compare-btn" style="background: #6c757d;">Data Info</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="loading" id="loadingMessage">
                📊 Loading actual KAM data...
            </div>

            <div id="dashboardContent" style="display: none;">
                <div class="dashboard-grid">
                    <div class="chart-container">
                        <div class="chart-title">KAMs by Company</div>
                        <canvas id="companyChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">KAMs by Year</div>
                        <canvas id="yearChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">KAMs by Auditor</div>
                        <canvas id="auditorChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">KAM Trends Over Time</div>
                        <canvas id="trendChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">🎯 Risk Assessment Matrix</div>
                        <canvas id="riskMatrixChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">📊 Risk Category Evolution</div>
                        <canvas id="riskEvolutionChart" class="chart-canvas"></canvas>
                    </div>
                </div>

                <!-- Year-based Auditor Table -->
                <div class="data-section" id="auditorTableSection" style="display: none;">
                    <div class="section-header" id="auditorSectionHeader">
                        📋 Exchange Auditors for Selected Year
                    </div>
                    <div style="padding: 20px;">
                        <div id="auditorTableContainer">
                            <!-- Dynamic auditor table will be populated here -->
                        </div>
                    </div>
                </div>

                <div class="data-section">
                    <div class="section-header">
                        🎯 Complete KAM Analysis - Key Audit Matters & Auditor Responses
                    </div>
                    <div class="cards-container" id="kamCardsContainer">
                        <!-- KAM cards will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Comparison Controls -->
    <div id="comparisonControls" class="comparison-controls">
        <div style="margin-bottom: 10px; font-weight: 600;">Compare Selected KAMs:</div>
        <div id="selectedCount">0 selected</div>
        <button class="compare-btn" onclick="openComparison()">Compare</button>
        <button class="compare-btn" onclick="clearSelection()" style="background: #dc3545;">Clear</button>
    </div>

    <!-- Comparison Modal -->
    <div id="comparisonModal" class="comparison-modal">
        <div class="comparison-content">
            <div class="comparison-header">
                <h3>KAM Comparison</h3>
                <button onclick="closeComparison()" style="background: none; border: none; color: white; font-size: 1.5em; cursor: pointer;">&times;</button>
            </div>
            <div class="comparison-body" id="comparisonBody">
                <!-- Comparison cards will be populated here -->
            </div>
        </div>
    </div>

    <!-- Load external KAM data file -->
    <script src="actual_kam_data.js"></script>

    <script>

        let kamData = [];
        let filteredData = [];
        let charts = {};
        let selectedKAMs = new Set();
        let searchSuggestions = [];

        // Enhanced Risk categorization function based on actual KAM data analysis
        function categorizeRisk(kamTitle, description) {
            const text = (kamTitle + ' ' + description).toLowerCase();

            // Revenue Recognition (including market technology, subscription revenue)
            if (text.includes('revenue') || text.includes('income') || text.includes('sales') ||
                text.includes('market technology') || text.includes('subscription') ||
                text.includes('transaction price') || text.includes('performance obligation')) {
                return { category: 'revenue', label: 'Revenue' };
            }
            // Valuation & Impairment (most common in exchange KAMs)
            else if (text.includes('valuation') || text.includes('impairment') || text.includes('goodwill') ||
                     text.includes('fair value') || text.includes('intangible') || text.includes('recoverable') ||
                     text.includes('cash-generating') || text.includes('discount rate') || text.includes('acquisition') ||
                     text.includes('business combination') || text.includes('purchase price') || text.includes('customer relationship')) {
                return { category: 'valuation', label: 'Valuation' };
            }
            // Compliance & Legal (including tax risks, regulatory matters)
            else if (text.includes('compliance') || text.includes('regulation') || text.includes('tax') ||
                     text.includes('legal') || text.includes('provision') || text.includes('dispute') ||
                     text.includes('investigation') || text.includes('regulatory') || text.includes('cum/ex') ||
                     text.includes('insolvency') || text.includes('litigation')) {
                return { category: 'compliance', label: 'Compliance' };
            }
            // Operational (including IT systems, controls, restructuring)
            else if (text.includes('operational') || text.includes('process') || text.includes('control') ||
                     text.includes('system') || text.includes('technology') || text.includes('restructuring') ||
                     text.includes('implementation') || text.includes('migration') || text.includes('infrastructure') ||
                     text.includes('segregation of duties') || text.includes('it general controls')) {
                return { category: 'operational', label: 'Operational' };
            }
            // Financial (including credit, liquidity, capital, financial instruments)
            else if (text.includes('financial') || text.includes('credit') || text.includes('liquidity') ||
                     text.includes('capital') || text.includes('instrument') || text.includes('derivative') ||
                     text.includes('investment') || text.includes('asset') || text.includes('liability')) {
                return { category: 'financial', label: 'Financial' };
            }
            else {
                return { category: 'other', label: 'Other' };
            }
        }

        // Dynamic KAM data loading from external file
        function loadKAMData() {
            try {
                // Check if external KAM data is available
                if (typeof ACTUAL_KAM_DATA !== 'undefined' && ACTUAL_KAM_DATA.length > 0) {
                    // Validate data structure
                    validateKAMData(ACTUAL_KAM_DATA);
                    kamData = ACTUAL_KAM_DATA;

                    // Log data source information
                    const sourceInfo = getDataSourceInfo();
                    console.log('📊 KAM Data Source Information:', sourceInfo);

                    filteredData = [...kamData];

                    initializeFilters();
                    updateStats();
                    createCharts();
                    updateCards();

                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('dashboardContent').style.display = 'block';

                    console.log(`✅ Loaded ${kamData.length} actual KAM records from external file: actual_kam_data.js`);

                    // Update success message to reflect external loading
                    const successMsg = document.querySelector('.success-message');
                    if (successMsg) {
                        successMsg.innerHTML = `
                            ✅ <strong>External KAM Data Loaded!</strong> Successfully loaded all ${kamData.length} verified KAM records with auditor responses from <code>actual_kam_data.js</code>.
                            Each card includes both the Key Audit Matter and the corresponding Auditor's Response from your tidied dataset.
                        `;
                    }

                    // Update data source information display
                    updateDataSourceDisplay(sourceInfo);
                } else {
                    throw new Error('External KAM data file not found or empty');
                }
            } catch (error) {
                console.error('Error loading external KAM data:', error);
                document.getElementById('loadingMessage').innerHTML = `
                    <div class="error">
                        ❌ Error loading KAM data from external file.<br>
                        <small>Please ensure 'actual_kam_data.js' is in the same directory and contains valid data.</small><br>
                        <button onclick="retryDataLoad()" style="margin-top: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            🔄 Retry Loading
                        </button>
                    </div>
                `;
            }
        }

        // Retry function for failed data loading
        function retryDataLoad() {
            document.getElementById('loadingMessage').innerHTML = '📊 Retrying KAM data load...';
            setTimeout(loadKAMData, 1000);
        }

        // Validate KAM data structure
        function validateKAMData(data) {
            if (!Array.isArray(data) || data.length === 0) {
                throw new Error('KAM data must be a non-empty array');
            }

            const requiredFields = ['id', 'company', 'year', 'auditor', 'kamTitle', 'description', 'auditResponse'];
            const sampleRecord = data[0];

            for (const field of requiredFields) {
                if (!(field in sampleRecord)) {
                    throw new Error(`Missing required field: ${field}`);
                }
            }

            // Check for data completeness
            const incompleteRecords = data.filter(record =>
                !record.kamTitle || !record.description || !record.auditResponse
            );

            if (incompleteRecords.length > 0) {
                console.warn(`⚠️ Found ${incompleteRecords.length} records with missing data`);
            }

            return true;
        }

        // Get data source information
        function getDataSourceInfo() {
            const totalRecords = kamData.length;
            const companies = [...new Set(kamData.map(item => item.company))];
            const auditors = [...new Set(kamData.map(item => item.auditor))];
            const years = [...new Set(kamData.map(item => item.year))].sort();

            return {
                totalRecords,
                companies: companies.length,
                auditors: auditors.length,
                yearRange: `${Math.min(...years)}-${Math.max(...years)}`,
                dataSource: 'actual_kam_data.js',
                lastLoaded: new Date().toLocaleString()
            };
        }

        // Update data source display
        function updateDataSourceDisplay(sourceInfo) {
            document.getElementById('recordCount').textContent = sourceInfo.totalRecords;
            document.getElementById('companyCount').textContent = sourceInfo.companies;
            document.getElementById('auditorCount').textContent = sourceInfo.auditors;
            document.getElementById('yearRange').textContent = sourceInfo.yearRange;
            document.getElementById('loadTime').textContent = sourceInfo.lastLoaded;
            document.getElementById('dataSourceInfo').style.display = 'block';
        }

        // Refresh data from external file
        function refreshData() {
            // Clear current data
            kamData = [];
            filteredData = [];
            selectedKAMs.clear();

            // Show loading message
            document.getElementById('dashboardContent').style.display = 'none';
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('loadingMessage').innerHTML = '🔄 Refreshing KAM data from external file...';

            // Force reload of the script (this will reload the page to get fresh data)
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        // Show detailed data information
        function showDataInfo() {
            if (kamData.length === 0) {
                alert('No data loaded yet.');
                return;
            }

            const sourceInfo = getDataSourceInfo();
            const companies = [...new Set(kamData.map(item => item.company))].sort();
            const auditors = [...new Set(kamData.map(item => item.auditor))].sort();

            const infoMessage = `
📊 KAM Dataset Information

📁 Data Source: ${sourceInfo.dataSource}
📈 Total Records: ${sourceInfo.totalRecords}
🏢 Companies (${sourceInfo.companies}): ${companies.join(', ')}
👥 Auditors (${sourceInfo.auditors}): ${auditors.join(', ')}
📅 Year Range: ${sourceInfo.yearRange}
🕒 Last Loaded: ${sourceInfo.lastLoaded}

🔍 Data Quality:
• All records have KAM titles: ${kamData.filter(r => r.kamTitle).length}/${kamData.length}
• All records have descriptions: ${kamData.filter(r => r.description).length}/${kamData.length}
• All records have auditor responses: ${kamData.filter(r => r.auditResponse).length}/${kamData.length}

💡 The data is dynamically loaded from the external JavaScript file, making it easy to update without modifying the dashboard code.
            `;

            alert(infoMessage);
        }

        function initializeFilters() {
            const companies = [...new Set(kamData.map(item => item.company))].sort();
            const auditors = [...new Set(kamData.map(item => item.auditor))].sort();
            const years = [...new Set(kamData.map(item => item.year))].sort((a, b) => b - a);

            // Get unique risk categories from the data
            const riskCategories = [...new Set(kamData.map(item => {
                const risk = categorizeRisk(item.kamTitle, item.description);
                return risk.label;
            }))].sort();

            populateSelect('companyFilter', companies);
            populateSelect('auditorFilter', auditors);
            populateSelect('yearFilter', years);
            populateSelect('yearSelector', years);
            populateSelect('riskCategoryFilter', riskCategories);

            // Add event listeners
            document.getElementById('companyFilter').addEventListener('change', applyFilters);
            document.getElementById('auditorFilter').addEventListener('change', applyFilters);
            document.getElementById('yearFilter').addEventListener('change', applyFilters);
            document.getElementById('riskCategoryFilter').addEventListener('change', applyFilters);
            document.getElementById('searchFilter').addEventListener('input', applyFilters);
        }

        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
        }

        // Enhanced search functions
        function handleSearch() {
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
            updateSearchSuggestions(searchTerm);
            applyFilters();
        }

        function updateSearchSuggestions(searchTerm) {
            if (searchTerm.length < 2) {
                hideSearchSuggestions();
                return;
            }

            const suggestions = new Set();
            kamData.forEach(item => {
                // Add matching companies
                if (item.company.toLowerCase().includes(searchTerm)) {
                    suggestions.add(item.company);
                }
                // Add matching auditors
                if (item.auditor.toLowerCase().includes(searchTerm)) {
                    suggestions.add(item.auditor);
                }
                // Add matching KAM titles
                if (item.kamTitle.toLowerCase().includes(searchTerm)) {
                    suggestions.add(item.kamTitle);
                }
            });

            displaySearchSuggestions(Array.from(suggestions).slice(0, 5));
        }

        function displaySearchSuggestions(suggestions) {
            const container = document.getElementById('searchSuggestions');
            if (suggestions.length === 0) {
                hideSearchSuggestions();
                return;
            }

            container.innerHTML = suggestions.map(suggestion =>
                `<div class="suggestion-item" onclick="selectSuggestion('${suggestion}')">${suggestion}</div>`
            ).join('');
            container.style.display = 'block';
        }

        function selectSuggestion(suggestion) {
            document.getElementById('searchFilter').value = suggestion;
            hideSearchSuggestions();
            applyFilters();
        }

        function showSearchSuggestions() {
            const searchTerm = document.getElementById('searchFilter').value;
            if (searchTerm.length >= 2) {
                updateSearchSuggestions(searchTerm);
            }
        }

        function hideSearchSuggestions() {
            setTimeout(() => {
                document.getElementById('searchSuggestions').style.display = 'none';
            }, 200);
        }

        function highlightSearchTerms(text, searchTerm) {
            if (!searchTerm || searchTerm.length < 2) return text;
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        function applyFilters() {
            const companyFilter = document.getElementById('companyFilter').value;
            const auditorFilter = document.getElementById('auditorFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            const riskCategoryFilter = document.getElementById('riskCategoryFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

            filteredData = kamData.filter(item => {
                const searchMatch = !searchFilter ||
                    item.kamTitle.toLowerCase().includes(searchFilter) ||
                    item.description.toLowerCase().includes(searchFilter) ||
                    item.auditResponse.toLowerCase().includes(searchFilter) ||
                    item.company.toLowerCase().includes(searchFilter) ||
                    item.auditor.toLowerCase().includes(searchFilter);

                // Check risk category match
                const riskInfo = categorizeRisk(item.kamTitle, item.description);
                const riskCategoryMatch = !riskCategoryFilter || riskInfo.label === riskCategoryFilter;

                return (!companyFilter || item.company === companyFilter) &&
                       (!auditorFilter || item.auditor === auditorFilter) &&
                       (!yearFilter || item.year.toString() === yearFilter) &&
                       riskCategoryMatch &&
                       searchMatch;
            });

            updateStats();
            updateCharts();
            updateCards();
        }

        function updateStats() {
            const companies = new Set(filteredData.map(item => item.company));
            const auditors = new Set(filteredData.map(item => item.auditor));
            const years = filteredData.map(item => item.year);

            document.getElementById('totalKAMs').textContent = filteredData.length;
            document.getElementById('totalCompanies').textContent = companies.size;
            document.getElementById('totalAuditors').textContent = auditors.size;
            document.getElementById('yearRange').textContent = years.length > 0 ? 
                `${Math.min(...years)}-${Math.max(...years)}` : '2015-2024';
        }

        function createCharts() {
            createCompanyChart();
            createYearChart();
            createAuditorChart();
            createTrendChart();
            createRiskMatrixChart();
            createRiskEvolutionChart();
        }

        function updateCharts() {
            Object.values(charts).forEach(chart => chart.destroy());
            createCharts();
        }

        function createCompanyChart() {
            const ctx = document.getElementById('companyChart').getContext('2d');
            const companyData = {};
            
            filteredData.forEach(item => {
                companyData[item.company] = (companyData[item.company] || 0) + 1;
            });

            charts.company = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(companyData),
                    datasets: [{
                        data: Object.values(companyData),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createYearChart() {
            const ctx = document.getElementById('yearChart').getContext('2d');
            const yearData = {};
            
            filteredData.forEach(item => {
                yearData[item.year] = (yearData[item.year] || 0) + 1;
            });

            const sortedYears = Object.keys(yearData).sort();

            charts.year = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedYears,
                    datasets: [{
                        label: 'Number of KAMs',
                        data: sortedYears.map(year => yearData[year]),
                        backgroundColor: '#36A2EB'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createAuditorChart() {
            const ctx = document.getElementById('auditorChart').getContext('2d');
            const auditorData = {};
            
            filteredData.forEach(item => {
                auditorData[item.auditor] = (auditorData[item.auditor] || 0) + 1;
            });

            charts.auditor = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(auditorData),
                    datasets: [{
                        label: 'Number of KAMs',
                        data: Object.values(auditorData),
                        backgroundColor: '#FFCE56'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            const companies = [...new Set(filteredData.map(item => item.company))];
            const years = [...new Set(filteredData.map(item => item.year))].sort();

            const datasets = companies.map((company, index) => {
                const data = years.map(year => {
                    return filteredData.filter(item => item.company === company && item.year === year).length;
                });

                return {
                    label: company,
                    data: data,
                    borderColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384'][index % 7],
                    fill: false,
                    tension: 0.1
                };
            });

            charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Enhanced Risk Assessment Matrix based on actual KAM data analysis
        function createRiskMatrixChart() {
            const ctx = document.getElementById('riskMatrixChart').getContext('2d');

            // Analyze actual KAM data to create risk matrix
            const riskAnalysis = analyzeRiskPatterns();

            charts.riskMatrix = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Revenue Recognition',
                        data: riskAnalysis.revenue,
                        backgroundColor: 'rgba(25, 118, 210, 0.6)',
                        borderColor: '#1976d2',
                        pointRadius: 8
                    }, {
                        label: 'Valuation & Impairment',
                        data: riskAnalysis.valuation,
                        backgroundColor: 'rgba(123, 31, 162, 0.6)',
                        borderColor: '#7b1fa2',
                        pointRadius: 8
                    }, {
                        label: 'Compliance & Legal',
                        data: riskAnalysis.compliance,
                        backgroundColor: 'rgba(56, 142, 60, 0.6)',
                        borderColor: '#388e3c',
                        pointRadius: 8
                    }, {
                        label: 'Operational',
                        data: riskAnalysis.operational,
                        backgroundColor: 'rgba(245, 124, 0, 0.6)',
                        borderColor: '#f57c00',
                        pointRadius: 8
                    }, {
                        label: 'Financial',
                        data: riskAnalysis.financial,
                        backgroundColor: 'rgba(211, 47, 47, 0.6)',
                        borderColor: '#d32f2f',
                        pointRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Frequency (Number of KAMs)'
                            },
                            beginAtZero: true
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Impact Level (1-5 scale)'
                            },
                            min: 1,
                            max: 5
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: Frequency ${context.parsed.x}, Impact ${context.parsed.y}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createRiskEvolutionChart() {
            const ctx = document.getElementById('riskEvolutionChart').getContext('2d');
            const years = [...new Set(filteredData.map(item => item.year))].sort();

            const riskCategories = ['revenue', 'valuation', 'compliance', 'operational', 'financial'];
            const colors = ['#1976d2', '#7b1fa2', '#388e3c', '#f57c00', '#d32f2f'];

            const datasets = riskCategories.map((category, index) => {
                const data = years.map(year => {
                    return filteredData.filter(item => {
                        const risk = categorizeRisk(item.kamTitle, item.description);
                        return item.year === year && risk.category === category;
                    }).length;
                });

                return {
                    label: category.charAt(0).toUpperCase() + category.slice(1),
                    data: data,
                    borderColor: colors[index],
                    backgroundColor: colors[index] + '20',
                    fill: true,
                    tension: 0.4
                };
            });

            charts.riskEvolution = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of KAMs'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Year'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateCards() {
            const container = document.getElementById('kamCardsContainer');
            container.innerHTML = '';
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase();

            const displayData = filteredData.slice(0, 100); // Show 100 cards to include more records

            displayData.forEach((item, index) => {
                const description = item.description || 'No description available';
                const auditResponse = item.auditResponse || 'No auditor response available';
                const riskInfo = categorizeRisk(item.kamTitle, description);

                // Apply search highlighting
                const highlightedTitle = highlightSearchTerms(item.kamTitle, searchTerm);
                const highlightedDescription = description.length > 200 ?
                    highlightSearchTerms(description.substring(0, 200), searchTerm) + '...' :
                    highlightSearchTerms(description, searchTerm);
                const highlightedAuditResponse = auditResponse.length > 200 ?
                    highlightSearchTerms(auditResponse.substring(0, 200), searchTerm) + '...' :
                    highlightSearchTerms(auditResponse, searchTerm);

                const card = document.createElement('div');
                card.className = 'kam-card';
                card.setAttribute('data-kam-id', item.id);
                card.innerHTML = `
                    <input type="checkbox" class="card-checkbox" onchange="toggleKAMSelection(${item.id}, this.checked)">
                    <div class="card-header">
                        <h3 class="card-title">${highlightedTitle}
                            <span class="risk-category risk-${riskInfo.category}">${riskInfo.label}</span>
                        </h3>
                        <div class="card-meta">
                            <span class="company-tag">${item.company}</span>
                            <span class="year-tag">${item.year}</span>
                            <span class="auditor-tag">${item.auditor}</span>
                        </div>
                    </div>
                    <div class="card-description">
                        <strong>📋 Key Audit Matter:</strong>
                        <div class="description-preview" id="desc-preview-${index}">
                            ${highlightedDescription}
                            ${description.length > 200 ?
                                `<span class="show-more-btn" onclick="toggleDescription(${index}, 'desc')">Show more</span>` : ''}
                        </div>
                        <div class="description-full" id="desc-full-${index}" style="display: none;">
                            ${highlightSearchTerms(description, searchTerm)}
                            ${description.length > 200 ?
                                `<span class="show-more-btn" onclick="toggleDescription(${index}, 'desc')">Show less</span>` : ''}
                        </div>
                    </div>
                    <div class="audit-response">
                        <div class="audit-response-header">🔍 Auditor's Response:</div>
                        <div class="audit-response-content">
                            <div class="description-preview" id="audit-preview-${index}">
                                ${highlightedAuditResponse}
                                ${auditResponse.length > 200 ?
                                    `<span class="show-more-btn" onclick="toggleDescription(${index}, 'audit')">Show more</span>` : ''}
                            </div>
                            <div class="description-full" id="audit-full-${index}" style="display: none;">
                                ${highlightSearchTerms(auditResponse, searchTerm)}
                                ${auditResponse.length > 200 ?
                                    `<span class="show-more-btn" onclick="toggleDescription(${index}, 'audit')">Show less</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #f1f3f4; font-size: 0.9em; color: #6c757d;">
                        💡 <strong>Related KAMs:</strong> <span id="related-${item.id}">Loading...</span>
                    </div>
                `;
                container.appendChild(card);

                // Load related KAMs asynchronously
                setTimeout(() => findRelatedKAMs(item.id), 100);
            });

            if (filteredData.length > 100) {
                const paginationInfo = document.createElement('div');
                paginationInfo.className = 'pagination-info';
                paginationInfo.innerHTML = `
                    Showing first 100 of ${filteredData.length} records. Use filters to narrow down results.
                `;
                container.appendChild(paginationInfo);
            }

            updateComparisonControls();
        }

        function toggleDescription(index, type) {
            const preview = document.getElementById(`${type}-preview-${index}`);
            const full = document.getElementById(`${type}-full-${index}`);

            if (preview.style.display === 'none') {
                preview.style.display = 'block';
                full.style.display = 'none';
            } else {
                preview.style.display = 'none';
                full.style.display = 'block';
            }
        }

        // Comparison functionality
        function toggleKAMSelection(kamId, isSelected) {
            if (isSelected) {
                selectedKAMs.add(kamId);
            } else {
                selectedKAMs.delete(kamId);
            }
            updateComparisonControls();
        }

        function updateComparisonControls() {
            const controls = document.getElementById('comparisonControls');
            const count = selectedKAMs.size;

            if (count > 0) {
                controls.style.display = 'block';
                document.getElementById('selectedCount').textContent = `${count} selected`;
            } else {
                controls.style.display = 'none';
            }
        }

        function openComparison() {
            if (selectedKAMs.size < 2) {
                alert('Please select at least 2 KAMs to compare.');
                return;
            }

            const modal = document.getElementById('comparisonModal');
            const body = document.getElementById('comparisonBody');
            body.innerHTML = '';

            const selectedData = kamData.filter(item => selectedKAMs.has(item.id));

            selectedData.forEach(item => {
                const riskInfo = categorizeRisk(item.kamTitle, item.description);
                const comparisonCard = document.createElement('div');
                comparisonCard.className = 'comparison-card';
                comparisonCard.innerHTML = `
                    <h4>${item.kamTitle} <span class="risk-category risk-${riskInfo.category}">${riskInfo.label}</span></h4>
                    <div style="margin-bottom: 15px;">
                        <span class="company-tag">${item.company}</span>
                        <span class="year-tag">${item.year}</span>
                        <span class="auditor-tag">${item.auditor}</span>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <strong>📋 Key Audit Matter:</strong>
                        <div style="margin-top: 8px; line-height: 1.5;">${item.description}</div>
                    </div>
                    <div class="audit-response">
                        <div class="audit-response-header">🔍 Auditor's Response:</div>
                        <div class="audit-response-content">${item.auditResponse}</div>
                    </div>
                `;
                body.appendChild(comparisonCard);
            });

            modal.style.display = 'block';
        }

        function closeComparison() {
            document.getElementById('comparisonModal').style.display = 'none';
        }

        function clearSelection() {
            selectedKAMs.clear();
            document.querySelectorAll('.card-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateComparisonControls();
        }

        // Smart recommendations
        function findRelatedKAMs(kamId) {
            const currentKAM = kamData.find(item => item.id === kamId);
            if (!currentKAM) return;

            const related = kamData
                .filter(item => item.id !== kamId)
                .map(item => {
                    let score = 0;

                    // Same company
                    if (item.company === currentKAM.company) score += 3;

                    // Same auditor
                    if (item.auditor === currentKAM.auditor) score += 2;

                    // Same risk category
                    const currentRisk = categorizeRisk(currentKAM.kamTitle, currentKAM.description);
                    const itemRisk = categorizeRisk(item.kamTitle, item.description);
                    if (currentRisk.category === itemRisk.category) score += 4;

                    // Similar keywords in title
                    const currentWords = currentKAM.kamTitle.toLowerCase().split(' ');
                    const itemWords = item.kamTitle.toLowerCase().split(' ');
                    const commonWords = currentWords.filter(word =>
                        word.length > 3 && itemWords.includes(word)
                    );
                    score += commonWords.length;

                    return { item, score };
                })
                .filter(result => result.score > 0)
                .sort((a, b) => b.score - a.score)
                .slice(0, 3);

            const relatedElement = document.getElementById(`related-${kamId}`);
            if (relatedElement) {
                if (related.length > 0) {
                    relatedElement.innerHTML = related.map(result =>
                        `<span style="cursor: pointer; color: #007bff; text-decoration: underline;"
                               onclick="scrollToKAM(${result.item.id})">${result.item.kamTitle.substring(0, 30)}...</span>`
                    ).join(', ');
                } else {
                    relatedElement.textContent = 'No related KAMs found';
                }
            }
        }

        function scrollToKAM(kamId) {
            const card = document.querySelector(`[data-kam-id="${kamId}"]`);
            if (card) {
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                card.style.border = '2px solid #007bff';
                setTimeout(() => {
                    card.style.border = '1px solid #e9ecef';
                }, 2000);
            }
        }

        // Risk pattern analysis based on actual KAM data
        function analyzeRiskPatterns() {
            const riskData = {
                revenue: [],
                valuation: [],
                compliance: [],
                operational: [],
                financial: []
            };

            // Analyze frequency and impact of each risk category
            const riskCounts = {};
            const riskImpacts = {
                revenue: 4.2,      // High impact based on revenue recognition complexity
                valuation: 4.8,    // Very high impact due to goodwill/impairment materiality
                compliance: 3.5,   // Medium-high impact for legal/regulatory risks
                operational: 3.2,  // Medium impact for operational risks
                financial: 4.0     // High impact for financial risks
            };

            filteredData.forEach(item => {
                const risk = categorizeRisk(item.kamTitle, item.description);
                riskCounts[risk.category] = (riskCounts[risk.category] || 0) + 1;
            });

            // Create scatter plot data points
            Object.keys(riskCounts).forEach(category => {
                if (riskData[category] !== undefined) {
                    riskData[category].push({
                        x: riskCounts[category],
                        y: riskImpacts[category] || 3.0
                    });
                }
            });

            return riskData;
        }

        // Year-based data update function
        function updateYearBasedData() {
            console.log('updateYearBasedData called');
            const selectedYear = document.getElementById('yearSelector').value;
            const headerElement = document.getElementById('auditorSectionHeader');

            console.log('Selected year:', selectedYear);
            console.log('Header element:', headerElement);

            if (selectedYear) {
                // Update section header with selected year
                headerElement.textContent = `📋 Exchange Auditors for ${selectedYear}`;

                // Show auditor table section
                document.getElementById('auditorTableSection').style.display = 'block';
                console.log('Calling createAuditorTable with year:', selectedYear);
                createAuditorTable(selectedYear);
            } else {
                // Reset header to default text
                headerElement.textContent = '📋 Exchange Auditors for Selected Year';

                // Hide auditor table section
                document.getElementById('auditorTableSection').style.display = 'none';
            }
        }

        // Create dynamic auditor table for selected year
        function createAuditorTable(year) {
            console.log('createAuditorTable called with year:', year);
            console.log('kamData length:', kamData.length);

            const yearData = kamData.filter(item => item.year.toString() === year);
            console.log('yearData length:', yearData.length);

            const exchangeAuditorMap = {};

            // Group by company (exchange) and count KAMs per auditor
            yearData.forEach(item => {
                if (!exchangeAuditorMap[item.company]) {
                    exchangeAuditorMap[item.company] = {};
                }
                if (!exchangeAuditorMap[item.company][item.auditor]) {
                    exchangeAuditorMap[item.company][item.auditor] = 0;
                }
                exchangeAuditorMap[item.company][item.auditor]++;
            });

            let tableHTML = `
                <table class="auditor-table">
                    <thead>
                        <tr>
                            <th>Exchange</th>
                            <th>Auditor</th>
                            <th>KAM Count</th>
                            <th>Risk Categories</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            Object.keys(exchangeAuditorMap).sort().forEach(exchange => {
                Object.keys(exchangeAuditorMap[exchange]).forEach(auditor => {
                    const kamCount = exchangeAuditorMap[exchange][auditor];
                    const exchangeYearData = yearData.filter(item =>
                        item.company === exchange && item.auditor === auditor
                    );

                    // Analyze risk categories for this exchange-auditor combination
                    const riskCategories = {};
                    exchangeYearData.forEach(item => {
                        const risk = categorizeRisk(item.kamTitle, item.description);
                        riskCategories[risk.category] = (riskCategories[risk.category] || 0) + 1;
                    });

                    const riskCategoryTags = Object.keys(riskCategories)
                        .map(category => `<span class="risk-category risk-${category}">${category} (${riskCategories[category]})</span>`)
                        .join(' ');

                    tableHTML += `
                        <tr>
                            <td class="exchange-name">${exchange}</td>
                            <td class="auditor-name">${auditor}</td>
                            <td><span class="kam-count">${kamCount}</span></td>
                            <td>${riskCategoryTags}</td>
                        </tr>
                    `;
                });
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            console.log('Setting table HTML, length:', tableHTML.length);
            document.getElementById('auditorTableContainer').innerHTML = tableHTML;
            console.log('Table HTML set successfully');
        }

        // Export functionality
        function exportToPDF() {
            const printWindow = window.open('', '_blank');
            const exportData = selectedKAMs.size > 0 ?
                kamData.filter(item => selectedKAMs.has(item.id)) :
                filteredData;

            let htmlContent = `
                <html>
                <head>
                    <title>KAM Analysis Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .kam-item { margin-bottom: 30px; page-break-inside: avoid; }
                        .kam-title { font-size: 1.2em; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
                        .meta-info { margin-bottom: 15px; }
                        .tag { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.8em; margin-right: 5px; }
                        .company-tag { background: #007bff; color: white; }
                        .year-tag { background: #28a745; color: white; }
                        .auditor-tag { background: #6f42c1; color: white; }
                        .section { margin-bottom: 15px; }
                        .section-title { font-weight: bold; margin-bottom: 5px; }
                        .audit-response { background: #f8f9fa; padding: 10px; border-left: 4px solid #007bff; }
                        @media print { .kam-item { page-break-inside: avoid; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Key Audit Matters Analysis Report</h1>
                        <p>Generated on ${new Date().toLocaleDateString()}</p>
                        <p>Total Records: ${exportData.length}</p>
                    </div>
            `;

            exportData.forEach(item => {
                const riskInfo = categorizeRisk(item.kamTitle, item.description);
                htmlContent += `
                    <div class="kam-item">
                        <div class="kam-title">${item.kamTitle}</div>
                        <div class="meta-info">
                            <span class="tag company-tag">${item.company}</span>
                            <span class="tag year-tag">${item.year}</span>
                            <span class="tag auditor-tag">${item.auditor}</span>
                            <span class="tag" style="background: #6c757d; color: white;">${riskInfo.label}</span>
                        </div>
                        <div class="section">
                            <div class="section-title">📋 Key Audit Matter:</div>
                            <div>${item.description}</div>
                        </div>
                        <div class="section">
                            <div class="section-title">🔍 Auditor's Response:</div>
                            <div class="audit-response">${item.auditResponse}</div>
                        </div>
                    </div>
                `;
            });

            htmlContent += '</body></html>';

            printWindow.document.write(htmlContent);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => printWindow.print(), 500);
        }

        function exportToExcel() {
            const exportData = selectedKAMs.size > 0 ?
                kamData.filter(item => selectedKAMs.has(item.id)) :
                filteredData;

            let csvContent = "Company,Year,Auditor,KAM Title,Risk Category,Description,Auditor Response\n";

            exportData.forEach(item => {
                const riskInfo = categorizeRisk(item.kamTitle, item.description);
                const row = [
                    `"${item.company}"`,
                    item.year,
                    `"${item.auditor}"`,
                    `"${item.kamTitle}"`,
                    `"${riskInfo.label}"`,
                    `"${item.description.replace(/"/g, '""')}"`,
                    `"${item.auditResponse.replace(/"/g, '""')}"`
                ].join(',');
                csvContent += row + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `kam_analysis_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', loadKAMData);
    </script>
</body>
</html>
